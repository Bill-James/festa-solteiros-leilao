<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Festa dos Solteiros - LeilÃ£o</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, onValue, set, update, remove } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
    window.firebase = { initializeApp, getDatabase, ref, onValue, set, update, remove };
  </script>
</head>

<body class="bg-gray-100">
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect } = React;
const { initializeApp, getDatabase, ref, onValue, set, update, remove } = window.firebase;

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyBUbmHryijxLFMfe_YKOKLPfOAKJMIZd0A",
  authDomain: "festa-solteiros-leilao.firebaseapp.com",
  databaseURL: "https://festa-solteiros-leilao-default-rtdb.firebaseio.com",
  projectId: "festa-solteiros-leilao",
  storageBucket: "festa-solteiros-leilao.appspot.com",
  messagingSenderId: "774027959784",
  appId: "1:774027959784:web:f8a244f3b937732ca2985d"
};

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

function App() {

  const [view, setView] = useState("login");
  const [organizerPassword, setOrganizerPassword] = useState("");
  const [participantNumber, setParticipantNumber] = useState(null);
  const [experiences, setExperiences] = useState([]);
  const [currentTime, setCurrentTime] = useState(Date.now());

  const [newExp, setNewExp] = useState({
    title: "",
    description: "",
    duration: 120,
    startingBid: 500
  });

  /* â±ï¸ Tempo em tempo real */
  useEffect(() => {
    const i = setInterval(() => setCurrentTime(Date.now()), 100);
    return () => clearInterval(i);
  }, []);

  /* ðŸ”„ Sync experiÃªncias */
  useEffect(() => {
    const r = ref(database, "experiences");
    onValue(r, snap => {
      const d = snap.val();
      setExperiences(d ? Object.keys(d).map(k => ({ id:k, ...d[k] })) : []);
    });
  }, []);

  /* â¹ï¸ Encerrar automaticamente */
  useEffect(() => {
    const i = setInterval(() => {
      experiences.forEach(exp => {
        if (exp.status === "active" && exp.endTime <= Date.now()) {
          update(ref(database, `experiences/${exp.id}`), { status: "ended" });
        }
      });
    }, 500);
    return () => clearInterval(i);
  }, [experiences]);

  /* ðŸ”¢ NUMERO AUTOMÃTICO */
  const assignParticipantNumber = (eventId) => {
    const counterRef = ref(database, `experiences/${eventId}/participantCounter`);

    onValue(counterRef, snap => {
      const current = snap.val() || 0;
      const next = current + 1;

      update(ref(database, `experiences/${eventId}`), {
        participantCounter: next
      });

      setParticipantNumber(next);
      setView("participant");

    }, { onlyOnce:true });
  };

  /* ðŸ” LOGIN */
  const loginParticipant = () => {
    const active = experiences.find(e => e.status === "active");
    if (!active) return alert("Nenhum evento ativo");
    assignParticipantNumber(active.id);
  };

  const loginOrganizer = () => {
    if (organizerPassword === "admin123") {
      setView("organizer");
      setOrganizerPassword("");
    } else alert("Senha errada");
  };

  /* âž• Criar ExperiÃªncia */
  const createExperience = () => {
    if (!newExp.title) return;

    const id = Date.now().toString();
    set(ref(database, `experiences/${id}`), {
      ...newExp,
      status: "pending",
      currentBid: newExp.startingBid,
      leadingBidder: null,
      endTime: null,
      participantCounter: 0,
      createdAt: Date.now()
    });

    setNewExp({ title:"", description:"", duration:120, startingBid:500 });
  };

  /* â–¶ï¸ Controles */
  const startExp = id => update(ref(database, `experiences/${id}`), {
    status:"active",
    endTime: Date.now() + experiences.find(e=>e.id===id).duration*1000
  });

  const pauseExp = id => update(ref(database, `experiences/${id}`), { status:"paused" });
  const deleteExp = id => remove(ref(database, `experiences/${id}`));

  /* ðŸ’° Lances */
  const placeBid = (id, amount) => {
    const exp = experiences.find(e=>e.id===id);
    if (amount > exp.currentBid && exp.status==="active") {
      update(ref(database, `experiences/${id}`), {
        currentBid: amount,
        leadingBidder: participantNumber
      });
    }
  };

  /* â±ï¸ */
  const timeLeft = exp => {
    if (exp.status!=="active") return "--";
    const r = Math.max(0, exp.endTime-currentTime);
    return Math.floor(r/60000)+":"+String(Math.floor((r%60000)/1000)).padStart(2,"0");
  };

  /* ================== TELAS ================== */

  if (view==="login") return (
    <div className="min-h-screen flex items-center justify-center">
      <div className="bg-white p-8 rounded-xl shadow-xl w-96 space-y-4">
        <h1 className="text-2xl font-bold text-center">Festa dos Solteiros</h1>

        <button onClick={loginParticipant}
          className="w-full bg-pink-500 text-white py-3 rounded">
          Entrar como Participante
        </button>

        <input type="password" placeholder="Senha organizador"
          value={organizerPassword}
          onChange={e=>setOrganizerPassword(e.target.value)}
          className="w-full border p-2 rounded"/>

        <button onClick={loginOrganizer}
          className="w-full bg-gray-800 text-white py-3 rounded">
          Painel do Organizador
        </button>
      </div>
    </div>
  );

  if (view==="participant") return (
    <div className="p-6">
      <h2 className="text-xl font-bold mb-4">VocÃª Ã© o participante #{participantNumber}</h2>

      {experiences.map(exp=>(
        <div key={exp.id} className="bg-white p-4 rounded shadow mb-3">
          <h3 className="font-bold">{exp.title}</h3>
          <p>Lance atual: {exp.currentBid} Kz</p>
          <p>Liderando: #{exp.leadingBidder || "---"}</p>
          <p>Tempo: {timeLeft(exp)}</p>

          {exp.status==="active" &&
            <button onClick={()=>placeBid(exp.id, exp.currentBid+100)}
              className="mt-2 bg-pink-500 text-white px-4 py-2 rounded">
              Dar Lance
            </button>}
        </div>
      ))}
    </div>
  );

  return (
    <div className="p-6">
      <h2 className="text-2xl font-bold mb-4">Painel do Organizador</h2>

      <input placeholder="TÃ­tulo"
        value={newExp.title}
        onChange={e=>setNewExp({...newExp,title:e.target.value})}
        className="border p-2 mb-2 w-full"/>

      <textarea placeholder="DescriÃ§Ã£o"
        value={newExp.description}
        onChange={e=>setNewExp({...newExp,description:e.target.value})}
        className="border p-2 mb-2 w-full"/>

      <button onClick={createExperience}
        className="bg-green-500 text-white px-4 py-2 rounded">
        Criar ExperiÃªncia
      </button>

      <hr className="my-4"/>

      {experiences.map(exp=>(
        <div key={exp.id} className="border p-3 mb-2 rounded">
          <b>{exp.title}</b> â€” {exp.status}
          <div className="space-x-2 mt-2">
            <button onClick={()=>startExp(exp.id)} className="bg-green-500 text-white px-2 py-1 rounded">Start</button>
            <button onClick={()=>pauseExp(exp.id)} className="bg-yellow-500 text-white px-2 py-1 rounded">Pause</button>
            <button onClick={()=>deleteExp(exp.id)} className="bg-red-500 text-white px-2 py-1 rounded">X</button>
          </div>
        </div>
      ))}
    </div>
  );
}

ReactDOM.render(<App/>, document.getElementById("root"));
</script>
</body>
</html>
